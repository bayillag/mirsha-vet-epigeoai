import streamlit as st
import pandas as pd
from src.core import database as db

st.set_page_config(page_title="Triage Dashboard", page_icon=" triage_icon  triage_icon triage_icon triage_icon triage_icon  triage_icon triage_icon triage_icon triage_icon triage_icon  triage_icon triage_icon triage_icon triage_icon  triage_icon  triage_icon  triage_icon triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon triage_icon  triage_icon  triage_icon  triage_icon triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon  triage_icon -a-kind ambulance ", layout="wide")

st.title("🚨 Triage Dashboard (Module 1)")
st.markdown("View and assign new, unassigned outbreak reports for investigation.")

# --- Placeholder for Investigators List ---
INVESTIGATORS = ["Dr. Alemayehu", "Dr. Bekele", "Dr. Chala", "Field Team Alpha"]

# --- Main Logic ---
reports_df = db.get_unassigned_reports()

if st.button("🔄 Refresh Reports"):
    # Clear cache and rerun to get fresh data
    st.cache_data.clear()
    st.experimental_rerun()

if reports_df.empty:
    st.success("✅ No unassigned reports. All clear!")
else:
    st.info(f"You have **{len(reports_df)}** new reports requiring triage.")
    
    for index, row in reports_df.iterrows():
        with st.expander(f"**Report ID: {row['outbreak_id']}** | Woreda: {row['woreda_name']} | Reported on: {row['report_date']}"):
            st.markdown(f"**Species Affected:** {', '.join(row['species_affected'])}")
            st.markdown(f"**Initial Complaint:**")
            st.write(row['initial_complaint'])
            st.markdown("---")
            
            investigator = st.selectbox(
                "Assign to Investigator",
                options=INVESTIGATORS,
                key=f"investigator_{row['outbreak_id']}"
            )
            
            if st.button("Assign", key=f"assign_{row['outbreak_id']}", type="primary"):
                with st.spinner("Assigning..."):
                    success, message = db.assign_investigator_to_outbreak(row['outbreak_id'], investigator)
                if success:
                    st.success(message)
                    st.experimental_rerun() # Refresh the page to remove the assigned report
                else:
                    st.error(message)